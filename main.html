<!DOCTYPE html>
<html>
  <head>
    <title>UpShot safari Extension</title>
  </head>
  <script type="text/javascript" charset="utf-8">
    // ////////////////////////////////////////////////////////////////////////
    // Here we are in the global safari application.
    // No access to web pages, but to safari app elements and listening scripts.
    // ////////////////////////////////////////////////////////////////////////
    
    function myCommandHandler(event){
      
      var box = '';
      if( event.command==="upshot" && safari.extension.settings.is_opened===0 && has_credentials() ){
        
        box = box + "\
          <div id='upshot_safari_box'>\
            <img id='base64' name='upshot[base64]' src='" + safari.application.activeBrowserWindow.activeTab.visibleContentsAsDataURL() + "' alt='image.png' />\
            <div id='accounts'>accounts select</div>\
            <p id='buttons'>\
              <button id='upshot_safari_cancel' class='red' type='reset' formnovalidate='formnovalidate'>Cancel</button>\
              <button type='button' name='commit' value='Draft' id='Draft' formnovalidate='formnovalidate'>Draft</button>\
            </p>\
          </div>";
        
        safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("shot", box);
      } else if( !has_credentials() ){
        box = box + "\
          <div id='upshot_safari_box'>\
            <div id='main'>\
            <div class='options w2 fl'>\
              <div class='drop-shadow round'>\
            	  <div class='logo'>\
                  <img src='" + safari.extension.baseURI + "logo.png' alt='UpShot'>\
                  <p class='s-caps'>Safari Extension</p>\
                </div>\
                <h1>\
                  Your settings\
                  <span id='status'></span>\
                </h1>\
                <div class='fields mt9'>\
                  <ol>\
                    <li>\
                      <label>\
                        Email\
                        <input type='text' id='upshot_safari_email'/>\
                      </label>\
                    </li>\
                    <li>\
                      <label>\
                      	Your token\
                        <input type='text' id='upshot_safari_token'/>\
                      </label>\
                      <p><small>to get your token just go your profile page on http://upshotapp.com</small></p>\
                    </li>\
                    <li>\
                      <a class='button green big' id='upshot_safari_settings_save'>Save</a>\
                      <span id='connection_status'></span><br/>\
                      <small>or simply go to 'Safari/Preferences > Extensions > UpShot' to define them.</small>\
                    </li>\
                  </ol>\
                </div>\
              </div>\
            </div>\
          </div>";
        
        safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("credentials", box);
      }
      safari.extension.settings.is_opened = 1;
      // disabled extension while screenshooting, avoids to have several boxes
      event.target.disabled = true;
    }
    
    function myValidateHandler(event){
      if (event.command === "upshot") {
        // Is there an URL loaded in the tab.
    		var has_url = event.target.browserWindow.activeTab.url;
	        // Disable the button if there is no URL loaded in the tab.
	        event.target.disabled = !has_url;
          // if there is no url, say it's already open so it won't try
          // otherwise, say it's not opened so it will be able to try.
	        safari.extension.settings.is_opened = has_url ? 0 : 1;
	    }
    }
    
    function myMessageHandler(event) {
      if (event.name === "upshot_safari_extension") {
        if( event.message === "activate" ){
          // Is there an URL loaded in the tab.
      		var has_url = event.target.browserWindow.activeTab.url;
      		safari.extension.toolbarItems[0].disabled = !has_url;
      		safari.extension.settings.is_opened = 0;
        }
        else if (event.message === "upshot"){
          submission();
        }
		  }else if(event.name==="upshot_safari_credentials"){
		    safari.extension.secureSettings.upshot_safari_login=event.message.email;
		    safari.extension.secureSettings.upshot_safari_token=event.message.token;
        // Self message to try relaunching screenshooter after saving settings
		    myCommandHandler({"command": "upshot", "target": self});
		  }
  	}
  	
    // function myChangeHandler(event){
    //       console.log( event.key + " : " + event.newValue + " instead of " + event.oldValue );
    // }
  	
    // Test if login/token are setted
  	function has_credentials(){
      if (safari.extension.secureSettings.upshot_safari_login == undefined || safari.extension.secureSettings.upshot_safari_token == undefined){
        return false;
      } else return true;
    }
  	
    // Listen to events
    // 'command' events are received once click on extension is done
    // 'validate' events are received from safari to ensure the command is ready to be executed
    // 'message' events are received from injected script
    safari.application.addEventListener("command", myCommandHandler, false);
    safari.application.addEventListener("validate", myValidateHandler, false);
    safari.application.addEventListener("message", myMessageHandler, false);
    
    // Listen to settings changes
    // safari.extension.settings.addEventListener("change", myChangeHandler,false);
    // safari.extension.secureSettings.addEventListener("change", myChangeHandler,false);

    // ///////// 
    // UPSHOT 
    // /////////

    function submission(){
      // Form submission by clicking the 'Draft' button
    	// SENDING
      var xhr = new XMLHttpRequest();
      xhr.open("POST", "http://" + "designer" + ".upshot.dev/upshots", true);

      // Create form to handle callback
      var formData = new FormData();
      formData.append("upshot[base64]", safari.application.activeBrowserWindow.activeTab.visibleContentsAsDataURL());
      formData.append("upshot[title]", safari.application.activeBrowserWindow.activeTab.title);
      formData.append("upshot[temporary_owner_tag_list]", "");
      formData.append("email", safari.extension.secureSettings.upshot_safari_login);
      formData.append("token", safari.extension.secureSettings.upshot_safari_token);

      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
          safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("done", xhr.status);
        }
      }
      xhr.send(formData);
    }
    
  </script>
  <body></body>
</html>