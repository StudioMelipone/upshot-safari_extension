<!DOCTYPE html>
<html>
  <head>
    <title>UpShot safari Extension</title>
  </head>
  <script type="text/javascript" charset="utf-8">
    // ////////////////////////////////////////////////////////////////////////
    // Here we are in the global safari application.
    // No access to web pages, but to safari app elements and listening scripts.
    // ////////////////////////////////////////////////////////////////////////
    
    function myCommandHandler(event){
      
      var box = '';
      if( event.command==="upshot" && safari.extension.settings.is_opened===0 && has_credentials() ){
        
        box = box + "\
          <div id='upshot_safari_box'>\
            <img id='base64' name='upshot[base64]' src='" + safari.application.activeBrowserWindow.activeTab.visibleContentsAsDataURL() + "' alt='image.png' />\
            <div id='accounts'>accounts select</div>\
            <p id='buttons'>\
              <button id='upshot_safari_cancel' class='red' type='reset' formnovalidate='formnovalidate'>Cancel</button>\
              <button type='button' name='commit' value='Draft' id='Draft' formnovalidate='formnovalidate'>Draft</button>\
            </p>\
          </div>";
        
        safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("shot", box);
      } else if( !has_credentials() ){
        box = box + "\
          <div id='upshot_safari_box'>\
            <h2>Settings</h2>\
            <p>\
              Your credential are not defined yet, please go to 'Safari/Preferences > Extensions > UpShot' to define them.<br/>\
              <button id='upshot_safari_settings_save' type='button' formnovalidate='formnovalidate'>Save</button>\
            </p>\
          </div>";
        
        safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("credentials", box);
      }
      safari.extension.settings.is_opened = 1;
      // disabled extension while screenshooting, avoids to have several boxes
      event.target.disabled = true;
    }
    
    function myValidateHandler(event){
      if (event.command === "upshot") {
        // Is there an URL loaded in the tab.
    		var has_url = event.target.browserWindow.activeTab.url;
	        // Disable the button if there is no URL loaded in the tab.
	        event.target.disabled = !has_url;
          // if there is no url, say it's already open so it won't try
          // otherwise, say it's not opened so it will be able to try.
	        safari.extension.settings.is_opened = has_url ? 0 : 1;
	    }
    }
    
    function myMessageHandler(event) {
      if (event.name === "upshot_safari_extension") {
        if( event.message === "activate" ){
          // Is there an URL loaded in the tab.
      		var has_url = event.target.browserWindow.activeTab.url;
      		safari.extension.toolbarItems[0].disabled = !has_url;
      		safari.extension.settings.is_opened = 0;
        }
        else if (event.message === "upshot"){
          submission();
        }
		  }
  	}
  	
    // Test if login/token are setted
  	function has_credentials(){
      if (safari.extension.secureSettings.upshot_safari_login == undefined || safari.extension.secureSettings.upshot_safari_token == undefined){
        return false;
      } else return true;
    }
  	
    // Listen to events
    // 'command' events are received once click on extension is done
    // 'validate' events are received from safari to ensure the command is ready to be executed
    // 'message' events are received from injected script
    safari.application.addEventListener("command", myCommandHandler, false);
    safari.application.addEventListener("validate", myValidateHandler, false);
    safari.application.addEventListener("message", myMessageHandler, false);
    
    // self message
    safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("upshot_safari_extension", "activate");

    // ///////// 
    // UPSHOT 
    // /////////

    function submission(){
      // Form submission by clicking the 'Draft' button
    	// SENDING
      var xhr = new XMLHttpRequest();
      xhr.open("POST", "http://" + "designer" + ".upshot.dev/upshots", true);

      // Create form to handle callback
      var formData = new FormData();
      formData.append("upshot[base64]", safari.application.activeBrowserWindow.activeTab.visibleContentsAsDataURL());
      formData.append("upshot[title]", safari.application.activeBrowserWindow.activeTab.title);
      formData.append("upshot[temporary_owner_tag_list]", "");
      formData.append("email", safari.extension.secureSettings.upshot_safari_login);
      formData.append("token", safari.extension.secureSettings.upshot_safari_token);

      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
          safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("done", xhr.status);
        }
      }
      xhr.send(formData);
    }
    
  </script>
  <body></body>
</html>